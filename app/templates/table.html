<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table</title>

    <style>
        body {
            background-color: #f4f4f4;
        }

        table, th, td {
            margin: 0 auto;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: red;
        }

        tr:nth-child(even) {
            background-color: #d8d8d8;
        }

        td {
            position: relative;
            outline: 0;
        }

        td > .button-toolbar {
            display: none;
            border-top: none;
            position: absolute;
            top: 100%;
            left: 50%;
            left: -2px;
            width: calc(100% + 4px);
            z-index: 2;
            text-align: center;
        }

        .in-editing > .button-toolbar {
            display: flex;
            justify-content: center;
        }

        .in-editing {
            background-color: #fff;
            border: 2px solid rgb(155, 155, 155);
            border-radius: 0px;
            border-left: none;
            border-right: none;
            border-top: none;
        }

        .button-wrapper {
            padding: 5px;
            background-color: #fff;
            border: 2px solid rgb(155, 155, 155);
            border-top: none;
            border-radius: 0px 0px 5px 5px;
        }

        .saveBtn {
            background-color: rgb(30, 30, 255);
            color: white;
            border-radius: 6px;
            border: none;
            margin: 5px;
            height: 35px;
            width: 65px;
        }

        .cancelBtn {
            background-color: red;
            color: white;
            border-radius: 6px;
            border: none;
            margin: 5px;
            height: 35px;
            width: 65px;
        }
    </style>
</head>
<body>
    <h1> User Data </h1>

    <table>
        {% for header in table_data[0] %}
            <th id='header'>{{ header }}</th>
        {% endfor %}

        {% for row in table_data %}
            <tr>
                {% for item in row %}
                    <td class='{{ item }}' id='{{ item }}{{ row.id }}' width='{{ (row[item])|string|length * 30 }}px'>{{ row[item] }}</td>
                {% endfor %}
            </tr>
        {% endfor %}
    </table>


    <script>
        console.log('edit_table.js started successfully');

        class in_place_edits{
            // Get the tbody of the table inputted
            constructor(table){ 
                this.tbody = table.querySelector('tbody');
            }
            

            init() {
                this.tds = this.tbody.querySelectorAll('td'); // Create nodelist of all <td> elsements in the tbody ... note <th> (table header) will not be chosen
                // Loop through each <td> in tds
                this.tds.forEach(td => {
                    td.setAttribute('contenteditable', true); // Make each cell editable

                    // Adds click event on each cell
                    td.addEventListener('click', (ev) => {
                        // Only adds event if cell is not already in editing mode
                        if(!this.inEditing(td)) { 
                            this.startEditing(td);
                        };
                    });
                });
            }

            // When cell is clicked on
            startEditing(td) {

                // Find any other cells that are already in-editing mode
                const activeTD = this.findEditing();
                if(activeTD) {
                    this.cancelEditing(activeTD); // If an cell is already in-editing mode it cancels the editing mode
                };


                td.classList.add('in-editing'); // Adds 'in-editing' to className as cell is being edited 
                td.setAttribute('data-old-value', td.innerHTML); // Creates new attribute, to hold old value, for use when process is canceled
                this.createButtonToolbaar(td); // Created <div> with button toolbar
            }

            // Cancel process, reverts cell to previous state
            cancelEditing(td) {
                // Resets the data in the cell to the original
                //   Assumes you wanted to cancel the operation
                td.innerHTML = td.getAttribute('data-old-value');

                // Removes 'in-editing' from className as cell is no linger being edited
                td.classList.remove('in-editing');
            }

            // Saves data
            finishEditing(td) {
                // Reverts cell back with new data
                td.classList.remove('in-editing');
                this.removeToolbar(td);

                // Sends data to flask server
                var data = td.textContent;
                this.sendData(td, data);
            }

            // Find the element that contains 'in-editing' as a className
            inEditing(td) {
                return td.classList.contains('in-editing')
            }

            // Created <div> with toolbar
            createButtonToolbaar(td) {
                // Save button
                const saveBtn = document.createElement('button'); // Created element: for save button
                saveBtn.className = 'saveBtn'; // Sets the className of saveBtn
                saveBtn.textContent = 'Save'; // Text of btn

                // Cancel Button
                const cancelBtn = document.createElement('button'); // Created element: for cancel button
                cancelBtn.className = 'cancelBtn'; // Sets the className of cancelBtn
                cancelBtn.textContent = 'Cancel'; // Text of btn

                // Div to hold buttons
                const divBtn = document.createElement('div'); // Created element: for div to contain buttons
                divBtn.className = 'button-wrapper'; // Sets the className of div => button-wrapper

                // Div toolbar
                const toolbar = document.createElement('div'); // Created element: for the whole toolbar
                toolbar.className = 'button-toolbar'; // Sets the className of div => button-toolbar 
                toolbar.setAttribute('contenteditable', false); // So no content in the toolbar can be edited


                // Append buttons to div in order displayed (left to right)
                divBtn.appendChild(cancelBtn);
                divBtn.appendChild(saveBtn);

                // Append button-wrapper to button-toolbar
                toolbar.appendChild(divBtn);

                // Append button-toolbar to the cell
                td.appendChild(toolbar);

                // Selects the specific 2 buttons that were appended ... NOTE: not the elements created!! (saveBtn, cancelBtn)
                const btnSave = toolbar.querySelector('.saveBtn'); 
                const btnCancel = toolbar.querySelector('.cancelBtn');

                // Adds clock event to button
                btnSave.addEventListener('click', (ev) => {
                    ev.stopPropagation(); // Does not trigget the click event of cell, only that of the button
                    this.finishEditing(td); // Save teh edited data
                });

                btnCancel.addEventListener('click', (ev) => {
                    ev.stopPropagation(); // DOes not trigger the click event of cell, only that of the button
                    this.cancelEditing(td); // Converts cell back to previous state
                });
            }

            // Removes toolbar from cell
            removeToolbar(td) {
                const toolbar = td.querySelector('.button-toolbar'); // Gets toolbar <div>
                toolbar.remove(); // Removes it from cell
            }

            // Find element that is in editing mode
            findEditing() {
                // find()
                //     find element in array this.tds that sattisfies the function
                // call()
                //     calls the function with a this value
                return Array.prototype.find.call(this.tds, td => this.inEditing(td));
            }

            // With AJAX, send data to Flask server
            sendData(td, newData) { 
                // Creates XHR object
                var xhr = new XMLHttpRequest();

                // When finif=shed, just console.log response
                xhr.onload = function() {
                    console.log(xhr.responseText);
                }


                xhr.open('POST', '/saveData', true); // Activates //SaveData route and saveData() function 
                xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded'); // Set request header
                xhr.send(`data=${newData}&id=${td.id}`); // 2 Variables passed with AJAX

            }
        }


        const tableElement = document.querySelector('table'); // Get the table as a variable
        const editing = new in_place_edits(tableElement); // Connect table to class
        editing.init(); // trigger init() function on class in_place_edits

    </script>
</body>
</html>